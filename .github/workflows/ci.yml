# =============================================================================
# CI Pipeline — Banking-grade quality gates
# =============================================================================
# All actions pinned to SHA for supply chain integrity.
# No workflow may pass without: format, lint, test, audit, deny.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  CARGO_INCREMENTAL: 0

jobs:
  # ---------------------------------------------------------------------------
  # Format check — zero tolerance for style drift
  # ---------------------------------------------------------------------------
  fmt:
    name: rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  # ---------------------------------------------------------------------------
  # Clippy — treat all warnings as errors
  # ---------------------------------------------------------------------------
  clippy:
    name: clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: cargo clippy --all-targets --all-features -- -D warnings

  # ---------------------------------------------------------------------------
  # Tests — debug + release, multi-platform
  # ---------------------------------------------------------------------------
  test:
    name: test (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Run tests (debug)
        run: cargo test --all-features
      - name: Run tests (release)
        run: cargo test --release --all-features

  # ---------------------------------------------------------------------------
  # Security audit — deny known vulnerabilities
  # ---------------------------------------------------------------------------
  audit:
    name: cargo-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: Run audit
        run: cargo audit

  # ---------------------------------------------------------------------------
  # cargo-deny — license, ban, and source policy
  # ---------------------------------------------------------------------------
  # Advisory checks are handled by the cargo-audit job above and the daily
  # scheduled audit workflow (audit.yml). Keeping them separate avoids
  # coupling the advisory DB fetch to the license/ban/source checks.
  deny:
    name: cargo-deny (${{ matrix.check }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [licenses, bans, sources]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: EmbarkStudios/cargo-deny-action@3fd3802e88374d3fe9159b834c7714ec57d6c979 # v2.0.15
        with:
          command: check ${{ matrix.check }}

  # ---------------------------------------------------------------------------
  # Build — release binary for deployment targets
  # ---------------------------------------------------------------------------
  build:
    name: build (${{ matrix.os }})
    needs: [fmt, clippy, test]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: cargo build --release
      - name: Upload binary
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: vbw-${{ matrix.os }}
          path: target/release/vbw
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Dogfooding — VBW witnesses its own build
  # ---------------------------------------------------------------------------
  # Uses `vbw build` to witness the release build, then `vbw verify` on the
  # resulting bundle. This proves the build-verify chain works end-to-end
  # and that VBW can verify itself.
  dogfood:
    name: dogfood
    needs: [fmt, clippy, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Build VBW (bootstrap binary)
        run: cargo build --release
      - name: VBW witnesses its own build
        run: |
          ./target/release/vbw build \
            --output-dir vbw-witness \
            --artifact target/release/vbw \
            -- cargo build --release
      - name: Verify witness bundle
        run: |
          ./target/release/vbw verify vbw-witness \
            --no-external --dry-run --slsa-mode schema-only
      - name: Show report
        run: cat vbw-witness/vbw/report.json
      - name: Upload witness bundle
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: vbw-witness-bundle
          path: vbw-witness/
          retention-days: 30
